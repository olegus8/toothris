#!/bin/sh

set -e

URL="github.com/toothris"
WIDTH=320
HEIGHT=240
START_LEN=220
START_SIZE=80
FPS=60
DISPLAY=:1
SILENCE=2

xmp -d wav -o music.wav res/artificial_sweetener.xm

rm -rf blank.bmp
convert -size ${WIDTH}x${HEIGHT} xc:black blank.bmp

FRAME=0
rm -rf start*.bmp
while [ $FRAME -lt $START_LEN ] ; do
  if [[ $((FRAME % 10)) -eq 0 ]] ; then echo "start frame $FRAME" ; fi
  SCALE=$(bc <<< "scale=2; $START_SIZE+((100-$START_SIZE)*$FRAME/$START_LEN)")
  convert \
    '(' '(' -background black -fill white -gravity center \
            -font /usr/share/fonts/TTF/DejaVuSansMono.ttf \
            -pointsize 90 label:"$URL" \
            -resize 1600x1200 ')' \
        -resize $SCALE% \
        -gravity center \
        -extent 1600x1200 ')' \
    -resize ${WIDTH}x${HEIGHT} \
    -gravity center \
    -extent ${WIDTH}x${HEIGHT} \
    $(printf 'start%06d.bmp' $FRAME)
  ((FRAME += 1))
done

Xvfb $DISPLAY -screen 0 ${WIDTH}x${HEIGHT}x24 &
XVFB=$!

rm -rf game*.bmp
set +e
python2 -B toothris.py --width $WIDTH --height $HEIGHT --fps $FPS \
  --freefps --replay --events event_logs/demo.events --frames 'game%06d.bmp'
set -e

kill $XVFB

rm -rf toothris${WIDTH}x${HEIGHT}.mkv
ffmpeg \
  -i music.wav \
  -loop 1 -t $SILENCE -r $FPS -i blank.bmp \
  -r $FPS -i 'start%06d.bmp' \
  -r $FPS -i 'game%06d.bmp' \
  -loop 1 -t $SILENCE -r $FPS -i start000000.bmp \
  -filter_complex "\
    aevalsrc=0:d=${SILENCE} [silence];\
    [1:0] [2:0] [3:0] [4:0] concat=n=4:v=1:a=0 [v];\
    [silence] [0:0] concat=n=2:v=0:a=1 [a]" \
  -map "[v]" -map "[a]" \
  -c:a libfdk_aac -b:a 256k \
  -c:v libx264 -crf 18 \
  toothris${WIDTH}x${HEIGHT}.mkv
